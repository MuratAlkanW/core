image: gitlab.lab:4567/liman/docker:latest

before_script:
  - rm `pwd`/build_tools/liman_req.sh
  - cd build_tools
  - mkdir -p liman
  - git config --global http.sslVerify false
  - git clone --depth=50 --branch=master https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.lab/liman/liman.git liman/server
  - git clone --depth=50 --branch=master https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.lab/liman/sandbox.git liman/sandbox
  - git clone --depth=50 --branch=master https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.lab/liman/webssh.git liman/webssh
  - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  - php -r "if (hash_file('sha384', 'composer-setup.php') === '48e3236262b34d30969dca3c37281b3b4bbe3221bda826ac6a9a62d6444cdb0dcd0615698a5cbe587c3f0fe57a54d8f5') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
  - php composer-setup.php
  - php7.3 composer.phar install --no-dev -d liman/server
  - rm -rf composer.phar composer-setup.php liman/server/.git liman/sandbox/.git liman/webssh/.git
  - mv create_deb.sh ../create_deb.sh
  - chmod +x ../create_deb.sh
  - export VERSION=$(date +'%Y.%m.%d-%s')
  - sed -i "s/APP_VERSION=Development/APP_VERSION=$VERSION/g" liman/server/.env
  - sed -i "s/APP_DEBUG=true/APP_DEBUG=false/g" liman/server/.env
  - sed -i "s/APP_ENV=local/APP_ENV=production/g" liman/server/.env
job:
  stage: deploy
  script:
    - chmod -R 775 DEBIAN/
    - ../create_deb.sh `cat liman/server/.env | grep "APP_VERSION" | cut -d "=" -f 2`
    - cp ../build_tools.deb ../liman-$VERSION.deb
    - echo "file=@/builds/liman/liman/liman-$VERSION.deb"
    - echo "https://slack.com/api/files.upload?token=xoxb-474187933397-695167035444-5gpwY1sVlknWFuZvnQjbtbKl&channels=liman-build&filename=liman-$VERSION&initial_comment=`date`&pretty=1"
    - curl -F "file=@/builds/liman/liman/liman-$VERSION.deb" "https://slack.com/api/files.upload?token=xoxb-474187933397-695167035444-5gpwY1sVlknWFuZvnQjbtbKl&channels=liman-build&filename=liman-$VERSION.deb&pretty=1"
  artifacts:
    name: liman_$CI_BUILD_ID
    paths:
    - /builds/liman/liman/build_tools.deb